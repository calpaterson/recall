#!/usr/bin/env bash
set -e

PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/..

export RECALL_API_BASE_URL='http://localhost:6000'
export RECALL_API_HOST="localhost"
export RECALL_API_PORT=6000
export RECALL_ELASTICSEARCH_HOST=localhost
export RECALL_ELASTICSEARCH_PORT=9200
export RECALL_ELASTICSEARCH_INDEX=test
export RECALL_MONGODB_DB_NAME=test
export RECALL_MONGODB_HOST=localhost
export RECALL_MONGODB_PORT=27017
export RECALL_PASSWORD_SALT='$2a$04$HDPphuN9nmnFLPxt.fWQ3e'
export RECALL_REDIS_HOST=localhost
export RECALL_REDIS_DB=15
export RECALL_REDIS_PORT=6379
export RECALL_DEBUG_MODE=true

python -3 ${PROJECT_ROOT}/server/server.py &
SERVER_PID=$!
python -3 ${PROJECT_ROOT}/worker/worker.py &
WORKER_PID=$!

trap 'kill $SERVER_PID; kill $WORKER_PID' SIGINT SIGTERM EXIT

python -m unittest discover -s $PROJECT_ROOT -v